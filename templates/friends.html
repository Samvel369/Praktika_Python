{% extends 'base.html' %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 30px;">

  <!-- –í–æ–∑–º–æ–∂–Ω—ã–µ –¥—Ä—É–∑—å—è -->
  <section>
    <h2>–í–æ–∑–º–æ–∂–Ω—ã–µ –¥—Ä—É–∑—å—è:</h2>
    {% if users %}
      {% for user in users %}
        <div data-user-id="{{ user.id }}" style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ user.avatar_url }}" alt="avatar"
               style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <a href="{{ url_for('view_profile', user_id=user.id) }}"><strong>{{ user.username }}</strong></a><br>
            <a href="{{ url_for('view_profile', user_id=user.id) }}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
          </div>
          <form method="post" action="{{ url_for('send_friend_request', user_id=user.id) }}" style="margin-right: 5px;">
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
          </form>
          <form method="post" action="{{ url_for('subscribe', user_id=user.id) }}">
            <button type="submit">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p>–ù–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥—Ä—É–∑–µ–π.</p>
    {% endif %}
  </section>

  <hr>

  <!-- –í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏ -->
  <section>
    <h2>–í—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏:</h2>
    <div id="requests-list">
    {% if incoming_requests %}
      {% for req in incoming_requests %}
        <div data-request-id="{{ req.id }}" style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ req.sender.avatar_url }}" alt="avatar"
               style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="{{ url_for('view_profile', user_id=req.sender.id) }}">{{ req.sender.username }}</a></strong><br>
            <a href="{{ url_for('view_profile', user_id=req.sender.id) }}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
          </div>
          <form method="post" action="{{ url_for('accept_friend_request', request_id=req.id) }}" style="margin-right: 5px;">
            <button type="submit">–ü—Ä–∏–Ω—è—Ç—å</button>
          </form>
          <form method="POST" action="{{ url_for('cancel_friend_request', request_id=req.id) }}">
              <input type="hidden" name="subscribe" value="true">
              <button type="submit">–û—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞—Ö</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p>–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫.</p>
    {% endif %}
    </div>
  </section>

  <hr>

  <!-- –ò—Å—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏ -->
  <section>
    <h2>–ò—Å—Ö–æ–¥—è—â–∏–µ –∑–∞—è–≤–∫–∏:</h2>
    <div id="outgoing-requests">
    {% if outgoing_requests %}
      {% for req in outgoing_requests %}
        <div data-request-id="{{ req.id }}" style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ req.receiver.avatar_url }}" alt="avatar"
               style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="{{ url_for('view_profile', user_id=req.receiver.id) }}">{{ req.receiver.username }}</a></strong><br>
            <a href="{{ url_for('view_profile', user_id=req.receiver.id) }}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
          </div>
          <form method="post" action="{{ url_for('cancel_friend_request', request_id=req.id) }}">
            <button type="submit">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p>–ù–µ—Ç –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫.</p>
    {% endif %}
    </div>
  </section>

  <hr>

  <!-- –î—Ä—É–∑—å—è -->
  <section>
    <h2>–ú–æ–∏ –¥—Ä—É–∑—å—è:</h2>
    <div id="friends-list">
    {% if friends %}
      {% for user in friends %}
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ user.avatar_url }}" alt="avatar"
               style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="{{ url_for('view_profile', user_id=user.id) }}">{{ user.username }}</a></strong><br>
            <a href="{{ url_for('view_profile', user_id=user.id) }}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
          </div>
          <form method="post" action="{{ url_for('remove_friend', user_id=user.id) }}">
            <button type="submit">–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p id="no-friends-msg">–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π.</p>
    {% endif %}
    </div>
  </section>

  <hr>

  <section>
    <h2>–ü–æ–¥–ø–∏—Å—á–∏–∫–∏:</h2>
    {% if subscribers %}
      {% for subscriber in subscribers %}
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ subscriber.avatar_url }}" alt="avatar"
              style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong>
              <a href="{{ url_for('view_profile', user_id=subscriber.id) }}">
                {{ subscriber.username }}
              </a>
            </strong>
            <br>
            <a href="{{ url_for('view_profile', user_id=subscriber.id) }}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>–ù–µ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.</p>
    {% endif %}
  </section>

  <!-- üîΩ –ù–æ–≤—ã–π –±–ª–æ–∫ "–ü–æ–¥–ø–∏—Å–∞–Ω:" -->
  <section>
    <h2>–ü–æ–¥–ø–∏—Å–∞–Ω:</h2>
    {% if subscriptions %}
      {% for user in subscriptions %}
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ user.avatar_url }}" alt="avatar"
              style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong>
              <a href="{{ url_for('view_profile', user_id=user.id) }}">
                {{ user.username }}
              </a>
            </strong>
            <br>
            <a href="{{ url_for('view_profile', user_id=user.id) }}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p>–í—ã –Ω–∏ –Ω–∞ –∫–æ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã.</p>
    {% endif %}
  </section>


</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Socket.IO –∏ —Ä–µ–∞–ª—Ç–∞–π–º –ª–æ–≥–∏–∫–∞ -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  socket.emit("join", { room: "user_{{ current_user.id }}" });

  socket.on('connect', () => {
    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ Socket.IO');
  });

  socket.on('friend_accepted', function (data) {
    const requestEl = document.querySelector(`[data-request-id="${data.request_id}"]`);
    if (requestEl) requestEl.remove();

    const friendsList = document.getElementById('friends-list');
    if (friendsList) {
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="${data.friend_avatar}" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="/profile/${data.friend_id}">${data.friend_username}</a></strong><br>
            <a href="/profile/${data.friend_id}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
          </div>
          <form method="post" action="/remove_friend/${data.friend_id}">
            <button type="submit">–£–¥–∞–ª–∏—Ç—å –∏–∑ –¥—Ä—É–∑–µ–π</button>
          </form>
        </div>
      `;
      friendsList.appendChild(div);
      const noMsg = document.getElementById('no-friends-msg');
      if (noMsg) noMsg.remove();
    }
  });

  socket.on('friend_removed', function(data) {
    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã —Å–∫—Ä—ã—Ç—å —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –¥—Ä—É–≥–∞
    location.reload();
  });

  socket.on('friend_request_cancelled', function (data) {
    const requestEl = document.querySelector(`[data-request-id="${data.request_id}"]`);
    if (requestEl) requestEl.remove();
  });

  socket.on('update_possible_friends', function(data) {
        // –ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –±–ª–æ–∫
        location.reload();
    });

    socket.on('friend_request_cancelled', function(data) {
        location.reload(); // –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∞
    });

    socket.on('new_subscriber', function(data) {
    const subscribersBlock = document.querySelector('section h2:contains("–ü–æ–¥–ø–∏—Å—á–∏–∫–∏:")')?.parentElement;
    if (!subscribersBlock) return;

    const noSubsMsg = subscribersBlock.querySelector('p');
    if (noSubsMsg) noSubsMsg.remove();

    const div = document.createElement('div');
    div.style = "display: flex; align-items: center; margin-bottom: 20px;";
    div.innerHTML = `
      <img src="${data.subscriber_avatar}" alt="avatar"
          style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
      <div style="flex-grow: 1;">
        <strong>
          <a href="/profile/${data.subscriber_id}">
            ${data.subscriber_username}
          </a>
        </strong>
        <br>
        <a href="/profile/${data.subscriber_id}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
      </div>
    `;
    subscribersBlock.appendChild(div);
  });

  socket.on('friend_request_sent', function (data) {
    const possible = document.querySelector(`[data-user-id="${data.sender_id}"]`);
    if (possible) possible.remove();

    const requestsList = document.getElementById('requests-list');
    if (requestsList) {
      const div = document.createElement('div');
      div.setAttribute('data-request-id', data.request_id);
      div.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="${data.sender_avatar}" style="width: 60px; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="/profile/${data.sender_id}">${data.sender_username}</a></strong><br>
            <a href="/profile/${data.sender_id}">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å</a>
          </div>
          <form method="post" action="/accept_friend_request/${data.request_id}" style="margin-right: 5px;">
            <button type="submit">–ü—Ä–∏–Ω—è—Ç—å</button>
          </form>
          <form method="post" action="/cancel_friend_request/${data.request_id}">
            <button type="submit">–û—Ç–º–µ–Ω–∏—Ç—å</button>
          </form>
        </div>
      `;
      requestsList.appendChild(div);
    }
  });
</script>

{% endblock %}
