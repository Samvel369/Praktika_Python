{% extends 'base.html' %}

{% block content %}
<div style="display: flex; flex-direction: column; gap: 30px;">

  <!-- Возможные друзья -->
  <section>
    <h2>Возможные друзья:</h2>
    {% if users %}
      {% for user in users %}
        <div data-user-id="{{ user.id }}" style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ user.avatar_url }}" alt="avatar"
               style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <a href="{{ url_for('view_profile', user_id=user.id) }}"><strong>{{ user.username }}</strong></a><br>
            <a href="{{ url_for('view_profile', user_id=user.id) }}">Перейти в профиль</a>
          </div>
          <form method="post" action="{{ url_for('send_friend_request', user_id=user.id) }}" style="margin-right: 5px;">
            <button type="submit">Добавить в друзья</button>
          </form>
          <form method="post" action="{{ url_for('remove_possible_friend', user_id=user.id) }}">
            <button type="submit">Удалить</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p>Нет возможных друзей.</p>
    {% endif %}
  </section>

  <hr>

  <!-- Входящие заявки -->
  <section>
    <h2>Входящие заявки:</h2>
    <div id="requests-list">
    {% if incoming_requests %}
      {% for req in incoming_requests %}
        <div data-request-id="{{ req.id }}" style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ req.sender.avatar_url }}" alt="avatar"
               style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="{{ url_for('view_profile', user_id=req.sender.id) }}">{{ req.sender.username }}</a></strong><br>
            <a href="{{ url_for('view_profile', user_id=req.sender.id) }}">Перейти в профиль</a>
          </div>
          <form method="post" action="{{ url_for('accept_friend_request', request_id=req.id) }}" style="margin-right: 5px;">
            <button type="submit">Принять</button>
          </form>
          <form method="post" action="{{ url_for('cancel_friend_request', request_id=req.id) }}">
            <button type="submit">Отменить</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p>Нет входящих заявок.</p>
    {% endif %}
    </div>
  </section>

  <hr>

  <!-- Исходящие заявки -->
  <section>
    <h2>Исходящие заявки:</h2>
    <div id="outgoing-requests">
    {% if outgoing_requests %}
      {% for req in outgoing_requests %}
        <div data-request-id="{{ req.id }}" style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ req.receiver.avatar_url }}" alt="avatar"
               style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="{{ url_for('view_profile', user_id=req.receiver.id) }}">{{ req.receiver.username }}</a></strong><br>
            <a href="{{ url_for('view_profile', user_id=req.receiver.id) }}">Перейти в профиль</a>
          </div>
          <form method="post" action="{{ url_for('cancel_friend_request', request_id=req.id) }}">
            <button type="submit">Отменить заявку</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p>Нет исходящих заявок.</p>
    {% endif %}
    </div>
  </section>

  <hr>

  <!-- Друзья -->
  <section>
    <h2>Мои друзья:</h2>
    <div id="friends-list">
    {% if friends %}
      {% for user in friends %}
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="{{ user.avatar_url }}" alt="avatar"
               style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="{{ url_for('view_profile', user_id=user.id) }}">{{ user.username }}</a></strong><br>
            <a href="{{ url_for('view_profile', user_id=user.id) }}">Перейти в профиль</a>
          </div>
          <form method="post" action="{{ url_for('remove_friend', user_id=user.id) }}">
            <button type="submit">Удалить из друзей</button>
          </form>
        </div>
      {% endfor %}
    {% else %}
      <p id="no-friends-msg">Пока нет друзей.</p>
    {% endif %}
    </div>
  </section>

</div>

<!-- Подключение Socket.IO и реалтайм логика -->
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const socket = io();
  socket.emit("join", { room: "user_{{ current_user.id }}" });

  socket.on('connect', () => {
    console.log('Подключено к Socket.IO');
  });

  socket.on('friend_accepted', function (data) {
    const requestEl = document.querySelector(`[data-request-id="${data.request_id}"]`);
    if (requestEl) requestEl.remove();

    const friendsList = document.getElementById('friends-list');
    if (friendsList) {
      const div = document.createElement('div');
      div.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="${data.friend_avatar}" style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="/profile/${data.friend_id}">${data.friend_username}</a></strong><br>
            <a href="/profile/${data.friend_id}">Перейти в профиль</a>
          </div>
          <form method="post" action="/remove_friend/${data.friend_id}">
            <button type="submit">Удалить из друзей</button>
          </form>
        </div>
      `;
      friendsList.appendChild(div);
      const noMsg = document.getElementById('no-friends-msg');
      if (noMsg) noMsg.remove();
    }
  });

  socket.on('friend_removed', function(data) {
    // Перезагрузка страницы, чтобы скрыть удалённого друга
    location.reload();
  });

  socket.on('friend_request_cancelled', function (data) {
    const requestEl = document.querySelector(`[data-request-id="${data.request_id}"]`);
    if (requestEl) requestEl.remove();
  });

  socket.on('friend_request_sent', function (data) {
    const possible = document.querySelector(`[data-user-id="${data.sender_id}"]`);
    if (possible) possible.remove();

    const requestsList = document.getElementById('requests-list');
    if (requestsList) {
      const div = document.createElement('div');
      div.setAttribute('data-request-id', data.request_id);
      div.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
          <img src="${data.sender_avatar}" style="width: 60px; border-radius: 50%; margin-right: 15px;">
          <div style="flex-grow: 1;">
            <strong><a href="/profile/${data.sender_id}">${data.sender_username}</a></strong><br>
            <a href="/profile/${data.sender_id}">Перейти в профиль</a>
          </div>
          <form method="post" action="/accept_friend_request/${data.request_id}" style="margin-right: 5px;">
            <button type="submit">Принять</button>
          </form>
          <form method="post" action="/cancel_friend_request/${data.request_id}">
            <button type="submit">Отменить</button>
          </form>
        </div>
      `;
      requestsList.appendChild(div);
    }
  });
</script>

{% endblock %}
